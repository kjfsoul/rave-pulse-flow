name: Update EDM News Feed

on:
  schedule:
    - cron: '0 11 * * *'  # 11:00 UTC = 6 AM EST
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug logging'
        required: false
        default: 'false'

jobs:
  update-feed:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --no-save rss-parser

      - name: Create output directory
        run: mkdir -p public/data

      - name: Generate feed
        id: generate
        run: |
          node scripts/generate-feed.js
          echo "status=success" >> "$GITHUB_OUTPUT"
        env:
          DEBUG: ${{ github.event.inputs.debug }}
        # REMOVED continue-on-error so failures are visible

      - name: Validate output
        run: |
          # Check file exists
          if [ ! -f public/data/edm-news.json ]; then
            echo "‚ùå Feed file not found"
            exit 1
          fi
          
          # Validate JSON structure and minimum items
          node -e "
            const data = require('./public/data/edm-news.json');
            
            // Check structure
            if (!data.metadata || !data.items) {
              console.error('‚ùå Invalid feed structure');
              process.exit(1);
            }
            
            // Require at least 10 items (not 60)
            if (data.items.length < 10) {
              console.error('‚ùå Insufficient items:', data.items.length);
              process.exit(1);
            }
            
            // Success metrics
            console.log('‚úÖ Feed validation passed');
            console.log('üìä Items:', data.metadata.totalItems);
            console.log('üì° Active sources:', data.metadata.activeSources + '/' + data.metadata.totalSources);
            console.log('‚ö†Ô∏è  Failed sources:', data.metadata.failedSources?.length || 0);
            
            // Warn if too many failures (but don't fail the build)
            const failureRate = (data.metadata.failedSources?.length || 0) / data.metadata.totalSources;
            if (failureRate > 0.5) {
              console.warn('‚ö†Ô∏è  Warning: More than 50% of sources failed');
            }
          "

      - name: Check for changes
        id: changes
        run: |
          git add public/data/*.json
          if git diff --staged --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "EDM News Bot"
          git config user.email "bot@github-actions"

          ITEMS=$(node -p "require('./public/data/edm-news.json').metadata.totalItems")
          SOURCES=$(node -p "require('./public/data/edm-news.json').metadata.activeSources")

          git commit -m "üéµ Update EDM news - $(date -u +'%Y-%m-%d %H:%M UTC')

          üìä $ITEMS items from $SOURCES sources"
          git push

      - name: Summary
        if: always()
        run: |
          echo "## üéµ EDM News Update" >> "$GITHUB_STEP_SUMMARY"
          if [ -f public/data/edm-news.json ]; then
            node -e "
              const d = require('./public/data/edm-news.json');
              console.log('**Status:** ‚úÖ Success');
              console.log('**Items:** ' + d.metadata.totalItems);
              console.log('**Sources:** ' + d.metadata.activeSources + '/' + d.metadata.totalSources);
              console.log('**Generated:** ' + d.metadata.generated);
              console.log('');
              console.log('**Top Stories:**');
              d.featured.slice(0,3).forEach((i,n) =>
                console.log((n+1) + '. ' + i.title + ' (' + i.source + ')')
              );
            " >> "$GITHUB_STEP_SUMMARY"
          else
            echo "**Status:** ‚ùå Failed" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Feed generation failed. Check logs above."
